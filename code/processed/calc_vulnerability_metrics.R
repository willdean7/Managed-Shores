#' calc_vulnerability_metrics
#'
#' This function calculates various vulnerability metrics for a dataset of Redfin properties
#' 
#' @param redfin_sf A data frame containing Redfin property data with columns for rent, structure value, 
#' land value, price, and elevation.
#' @return A data frame with additional columns for various vulnerability metrics.
# the vulnerability metrics include economic ratios, physical vulnerability metrics, and a combined vulnerability score.


# Function to calculate vulnerability metrics
calc_vulnerability_metrics <- function(redfin_sf) {
  redfin_sf %>%
    mutate(
      rent = as.numeric(rent),
      strval = as.numeric(strval),
      landval = as.numeric(landval),
      PRICE = as.numeric(PRICE),
      elevation = as.numeric(elevation),
      
      # Economic vulnerability ratios
      rent_to_structure_ratio = rent / strval,
      structure_to_total_ratio = strval / PRICE,
      land_to_total_ratio = landval / PRICE,
      
      # Physical vulnerability metrics
      elevation_per_dollar = elevation / PRICE * 1e6, # elevation per million dollars
      rent_per_elevation = rent / elevation,
      
      # Combined vulnerability score
      economic_vulnerability = strval / rent, # years to recover structure value
      flood_vulnerability = 1 / elevation, # inverse elevation (higher = more vulnerable)
      
      # Overall retreat pressure
      retreat_pressure = (strval / rent) * (1 / elevation),
      
      # Primary driver of vulnerability
      primary_driver = case_when(
        elevation < 3 & rent_to_structure_ratio < 0.05 ~ "Low Elevation + Poor Economics",
        elevation < 3 ~ "Low Elevation",
        rent_to_structure_ratio < 0.02 ~ "Poor Economics",
        retreat_pressure > quantile(retreat_pressure, 0.95, na.rm = TRUE) ~ "High Combined Pressure",
        TRUE ~ "Multiple Factors"),
      
      # Risk level
      risk_level = case_when(
        retreat_year == 1 ~ "Critical",
        retreat_year <= 25 ~ "High", 
        retreat_year <= 50 ~ "Moderate",
        retreat_year <= 75 ~ "Low",
        TRUE ~ "Minimal"
      )
    )
}
