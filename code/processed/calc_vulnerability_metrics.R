#' calc_vulnerability_metrics
#'
#' This function calculates various vulnerability metrics for a dataset of Redfin properties
#' 
#' @param redfin_sf A data frame containing Redfin property data with columns for rent, structure value, 
#' land value, price, and elevation.
#' @return A data frame with additional columns for various vulnerability metrics.
# the vulnerability metrics include economic ratios, physical vulnerability metrics, and a combined vulnerability score.


# Function to calculate vulnerability metrics
calc_vulnerability_metrics <- function(redfin_sf, retreat_year_prefix = "retreat_year_") {
  # Gather scenario retreat year columns to long format
  scenario_cols <- grep(paste0("^", retreat_year_prefix), names(redfin_sf), value=TRUE)
  redfin_long <- redfin_sf %>%
    tidyr::pivot_longer(
      cols = all_of(scenario_cols),
      names_to = "scenario",
      names_prefix = retreat_year_prefix,
      values_to = "retreat_year"
    )
  
  # Calculate vulnerability metrics per scenario
  redfin_long %>%
    dplyr::mutate(
      rent = as.numeric(rent),
      strval = as.numeric(strval),
      landval = as.numeric(landval),
      PRICE = as.numeric(PRICE),
      elevation = as.numeric(elevation),
      
      # Economic vulnerability ratios
      rent_to_structure_ratio = rent / strval,
      structure_to_total_ratio = strval / PRICE,
      land_to_total_ratio = landval / PRICE,
      
      # Physical vulnerability metrics
      elevation_per_dollar = elevation / PRICE * 1e6, # elevation per million dollars
      rent_per_elevation = rent / elevation,
      
      # Combined vulnerability score
      economic_vulnerability = strval / rent, # years to recover structure value
      flood_vulnerability = 1 / elevation, # inverse elevation (higher = more vulnerable)
      
      # Overall retreat pressure
      retreat_pressure = (strval / rent) * (1 / elevation),
      
      # Vulnerability driver component scores
      driver_elevation = scales::rescale(1 / elevation, to = c(0,1), na.rm = TRUE),
      driver_value     = scales::rescale(strval / rent, to = c(0,1), na.rm = TRUE),
      driver_rent      = scales::rescale(rent_to_structure_ratio, to = c(0,1), na.rm = TRUE),
      
      # Normalize to get relative weights (sums to 1)
      driver_total = driver_elevation + driver_value + driver_rent,
      weight_elevation = driver_elevation / driver_total,
      weight_value     = driver_value / driver_total,
      weight_rent      = driver_rent / driver_total,
      
      # Dominant driver assignment
      primary_driver = dplyr::case_when(
        weight_elevation >= 0.5 ~ "Elevation",
        weight_value     >= 0.5 ~ "Structure Value",
        weight_rent      >= 0.5 ~ "Rent",
        TRUE ~ "Multiple Factors"
      ),
      
      # Retreat category
      retreat_category = factor(
        dplyr::case_when(
          retreat_year <= 10 ~ "0-10 years",
          retreat_year <= 25 ~ "10-25 years",
          retreat_year <= 50 ~ "25-50 years",
          retreat_year <= 100 ~ "50-100 years",
          TRUE ~ ">100 years"
        ),
        levels = c("0-10 years", "10-25 years", "25-50 years", "50-100 years", ">100 years"),
        ordered = TRUE
      ),
      
      # Risk level
      risk_level = dplyr::case_when(
        retreat_year >= 1 & retreat_year <= 15 ~ "Critical",
        retreat_year > 16 & retreat_year <= 35 ~ "High", 
        retreat_year > 36 & retreat_year <= 65 ~ "Moderate",
        retreat_year > 66 & retreat_year <= 99 ~ "Low",
        retreat_year > 100 ~ "Minimal"
      )
    )
}
