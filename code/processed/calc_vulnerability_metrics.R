#' calc_vulnerability_metrics
#'
# Calculates economic and physical vulnerability indicators for each Redfin property,
# expanding retreat-year data across multiple sea-level rise scenarios and deriving
# combined vulnerability scores that help explain retreat timing and drivers.
#
# @param redfin_sf A data frame or sf object containing Redfin property data.
#        Required columns: rent, strval (structure value), landval, PRICE, elevation,
#        and one or more retreat year columns prefixed with 'retreat_year_'.
# @param retreat_year_prefix String prefix used to identify retreat-year columns
#        corresponding to different SLR scenarios (default: "retreat_year_").
#
# @return A long-format data frame with one row per property per scenario,
#         including economic ratios, physical metrics, and combined vulnerability scores.
# ------------------------------------------------------------------------------

calc_vulnerability_metrics <- function(redfin_sf, retreat_year_prefix = "retreat_year_") {
  
  # Identify retreat year columns for each scenario
  eps_elev <- 0.1  # small constant to avoid divide-by-zero when elevation = 0
  scenario_cols <- grep(paste0("^", retreat_year_prefix), names(redfin_sf), value = TRUE)
  
  # Pivot from wide → long format so that each scenario (e.g., Intermediate, High)
  # appears in its own row for each property.
  redfin_long <- redfin_sf %>%
    tidyr::pivot_longer(
      cols = all_of(scenario_cols),
      names_to = "scenario",
      names_prefix = retreat_year_prefix,
      values_to = "retreat_year"
    )
  
  # Compute vulnerability metrics for each property × scenario
  redfin_long %>%
    dplyr::mutate(
      # clean numeric fields
      rent      = as.numeric(rent),
      strval    = as.numeric(strval),
      landval   = as.numeric(landval),
      PRICE     = as.numeric(PRICE),
      elevation = pmax(as.numeric(elevation), eps_elev),  # enforce min elevation
      
      #  ECONOMIC VULNERABILITY METRICS
      rent_to_structure_ratio = rent / strval,       # annual rent ÷ structure value
      structure_to_total_ratio = strval / PRICE,     # portion of total price from structure
      land_to_total_ratio = landval / PRICE,         # portion of total price from land
      
      #  PHYSICAL VULNERABILITY METRICS
      elevation_per_dollar = elevation / PRICE * 1e6,   # meters of elevation per $1M
      rent_per_elevation   = rent / pmax(elevation, eps_elev),  # rent per meter elevation
      
      #  COMBINED VULNERABILITY SCORES
      economic_vulnerability = strval / rent,        # “years of rent” to recoup structure value
      flood_vulnerability    = 1 / pmax(elevation, eps_elev),   # inverse elevation = flood exposure
      
      # Overall retreat pressure combines both:
      # high structure value, low rent yield, and low elevation ⇒ high pressure.
      retreat_pressure = (strval / rent) * (1 / elevation),
      
      #  DRIVER COMPONENT SCORING (NORMALIZED 0–1)
      driver_elevation = scales::rescale(1 / elevation, to = c(0,1), na.rm = TRUE),
      driver_value     = scales::rescale(strval / rent, to = c(0,1), na.rm = TRUE),
      driver_rent      = scales::rescale(rent_to_structure_ratio, to = c(0,1), na.rm = TRUE),
      
      # Normalize driver components to sum to 1 for comparison of influence
      driver_total     = driver_elevation + driver_value + driver_rent,
      weight_elevation = driver_elevation / driver_total,
      weight_value     = driver_value / driver_total,
      weight_rent      = driver_rent / driver_total,
      
      # Assign the dominant vulnerability driver for each property
      primary_driver = dplyr::case_when(
        weight_elevation >= 0.5 ~ "Elevation",
        weight_value     >= 0.5 ~ "Structure Value",
        weight_rent      >= 0.5 ~ "Rent",
        TRUE                     ~ "Multiple Factors"
      ),
      
      #  RETREAT CATEGORY CLASSIFICATION
      # Categorizes retreat timing windows into human-readable bins
      retreat_category = factor(
        dplyr::case_when(
          retreat_year <= 10  ~ "0-10 years",
          retreat_year <= 25  ~ "10-25 years",
          retreat_year <= 50  ~ "25-50 years",
          retreat_year <= 100 ~ "50-100 years",
          TRUE                ~ ">100 years"
        ),
        levels = c("0-10 years", "10-25 years", "25-50 years",
                   "50-100 years", ">100 years"),
        ordered = TRUE
      ),
      
      #  RISK LEVEL CLASSIFICATION
      #not sure we need this
      # Converts numeric retreat_year into qualitative risk tiers used in the map legend.
      risk_level = dplyr::case_when(
        retreat_year >= 1   & retreat_year <= 15  ~ "Critical",
        retreat_year > 16   & retreat_year <= 35  ~ "High",
        retreat_year > 36   & retreat_year <= 65  ~ "Moderate",
        retreat_year > 66   & retreat_year <= 99  ~ "Low",
        retreat_year > 100                       ~ "Minimal"
      )
    )
}