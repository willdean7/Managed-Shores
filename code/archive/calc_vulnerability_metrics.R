#' calc_vulnerability_metrics
#' 
# This function post-processes the outputs of MSGRP_valuationcode_ms.R
# to derive interpretable vulnerability indicators for each parcel.
# It reshapes the Redfin + retreat-year dataset to long format
# (one row per property per sea-level-rise scenario) and computes:
#   - Economic metrics: rent-to-structure ratio, structure/land share of value
#   - Physical metrics: elevation per dollar, rent per elevation
#   - Combined scores: "retreat pressure" = (structure value ÷ rent) × (1 ÷ elevation)
#   - Normalized driver weights showing which factor dominates (elevation,
#     structure value, or rent yield)
#   - Retreat timing and qualitative risk tiers for map legends
#
# In short, it converts raw model outputs into standardized, comparable metrics
# that reveal which economic or physical characteristics most influence
# the timing of coastal retreat across scenarios.
#
# @param redfin_sf A data frame or sf object containing Redfin property data.
#        Required columns: rent, strval (structure value), landval, PRICE, elevation,
#        and one or more retreat year columns prefixed with 'retreat_year_'.
# @param retreat_year_prefix String prefix used to identify retreat-year columns
#        corresponding to different SLR scenarios (default: "retreat_year_").
#
# @return A long-format data frame with one row per property per scenario,
#         including economic ratios, physical metrics, and combined vulnerability scores.
# ------------------------------------------------------------------------------

calc_vulnerability_metrics <- function(redfin_sf, retreat_year_prefix = "retreat_year_") {
  stopifnot(inherits(redfin_sf, "sf"))
  
  eps_elev <- 0.1  # to avoid div-by-zero when elevation == 0
  
  # Find scenario columns safely
  scenario_cols <- grep(paste0("^", retreat_year_prefix), names(redfin_sf), value = TRUE)
  if (length(scenario_cols) == 0) {
    stop("No retreat-year columns found. Expected columns starting with: ", retreat_year_prefix)
  }
  
  # Wide -> long, preserving geometry
  redfin_long <- redfin_sf |>
    tidyr::pivot_longer(
      cols = dplyr::all_of(scenario_cols),
      names_to = "scenario",
      names_prefix = retreat_year_prefix,
      values_to = "retreat_year"
    ) |>
    dplyr::mutate(
      # Harmonize scenario names to match the app’s selectInput
      scenario = dplyr::recode(scenario,
                               "Intermediate_High" = "Intermediate High",
                               .default = scenario
      ),
      # Clean/guard numerics
      rent      = suppressWarnings(as.numeric(rent)),
      strval    = suppressWarnings(as.numeric(strval)),
      landval   = suppressWarnings(as.numeric(landval)),
      PRICE     = suppressWarnings(as.numeric(PRICE)),
      elevation = pmax(suppressWarnings(as.numeric(elevation)), eps_elev),
      retreat_year = suppressWarnings(as.numeric(retreat_year))
    )
  
  # Helper: safe ratio
  safe_div <- function(x, y) ifelse(is.finite(x) & is.finite(y) & y != 0, x / y, NA_real_)
  
  out <- redfin_long |>
    dplyr::mutate(
      # ECONOMIC METRICS
      rent_to_structure_ratio  = safe_div(rent, strval),
      structure_to_total_ratio = safe_div(strval, PRICE),
      land_to_total_ratio      = safe_div(landval, PRICE),
      
      # PHYSICAL METRICS
      elevation_per_dollar = safe_div(elevation, PRICE) * 1e6,  # m per $1M
      rent_per_elevation   = safe_div(rent, elevation),
      
      # COMBINED SCORES
      economic_vulnerability = safe_div(strval, rent),     # “years of rent” to recoup structure value
      flood_vulnerability    = safe_div(1, elevation),     # inverse elevation
      retreat_pressure       = safe_div(strval, rent) * safe_div(1, elevation),
      
      # DRIVER COMPONENTS (0–1)
      driver_elevation = scales::rescale(safe_div(1, elevation), to = c(0, 1), na.rm = TRUE),
      driver_value     = scales::rescale(safe_div(strval, rent), to = c(0, 1), na.rm = TRUE),
      driver_rent      = scales::rescale(rent_to_structure_ratio, to = c(0, 1), na.rm = TRUE)
    ) |>
    # Normalize driver weights robustly (avoid 0/0, all NAs)
    dplyr::rowwise() |>
    dplyr::mutate(
      driver_total     = sum(c_across(dplyr::all_of(c("driver_elevation","driver_value","driver_rent"))), na.rm = TRUE),
      weight_elevation = ifelse(driver_total > 0, driver_elevation / driver_total, NA_real_),
      weight_value     = ifelse(driver_total > 0, driver_value     / driver_total, NA_real_),
      weight_rent      = ifelse(driver_total > 0, driver_rent      / driver_total, NA_real_),
      primary_driver   = dplyr::case_when(
        is.na(driver_total) | driver_total == 0            ~ "Insufficient Data",
        weight_elevation >= 0.5                             ~ "Elevation",
        weight_value     >= 0.5                             ~ "Structure Value",
        weight_rent      >= 0.5                             ~ "Rent",
        TRUE                                                ~ "Multiple Factors"
      )
    ) |>
    dplyr::ungroup() |>
    # Retreat categories / labels
    dplyr::mutate(
      retreat_category = factor(
        dplyr::case_when(
          is.finite(retreat_year) & retreat_year <= 10   ~ "0-10 years",
          is.finite(retreat_year) & retreat_year <= 25   ~ "10-25 years",
          is.finite(retreat_year) & retreat_year <= 50   ~ "25-50 years",
          is.finite(retreat_year) & retreat_year <= 100  ~ "50-100 years",
          TRUE                                           ~ ">100 years"
        ),
        levels = c("0-10 years","10-25 years","25-50 years","50-100 years",">100 years"),
        ordered = TRUE
      ),
      risk_level = dplyr::case_when(
        is.finite(retreat_year) & retreat_year >= 1  & retreat_year <= 15  ~ "Critical",
        is.finite(retreat_year) & retreat_year >  15 & retreat_year <= 35  ~ "High",
        is.finite(retreat_year) & retreat_year >  35 & retreat_year <= 65  ~ "Moderate",
        is.finite(retreat_year) & retreat_year >  65 & retreat_year <= 99  ~ "Low",
        is.finite(retreat_year) & retreat_year >  100                      ~ "Minimal",
        TRUE                                                               ~ NA_character_
      ),
      retreat_category_label = dplyr::case_when(
        retreat_category == "0-10 years"   ~ "Immediate Retreat (0-10 years)",
        retreat_category == "10-25 years"  ~ "Early Retreat (10-25 years)",
        retreat_category == "25-50 years"  ~ "Mid-term Retreat (25-50 years)",
        retreat_category == "50-100 years" ~ "Late Retreat (50-100 years)",
        retreat_category == ">100 years"   ~ "Delayed Retreat",
        TRUE                               ~ NA_character_
      )
    )
  
  out
}